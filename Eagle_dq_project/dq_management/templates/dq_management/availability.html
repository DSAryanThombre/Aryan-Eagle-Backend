<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Eagle DQ - Define Availability Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base Background and Font */
        body {
            background: linear-gradient(135deg, #fef7ed 0%, #fdf4ff 25%, #f0f9ff 50%, #f0fdfa 75%, #fefce8 100%);
            font-family: 'Inter', sans-serif;
            color: #1e293b;
        }

        /* Colorful eagle-inspired background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 20% 80%, rgba(251, 191, 36, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(14, 165, 233, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 60% 60%, rgba(236, 72, 153, 0.04) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Main Content Card Style */
        .main-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(254, 252, 232, 0.3) 25%, rgba(240, 249, 255, 0.3) 75%, rgba(255, 255, 255, 0.9) 100%);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px rgba(251, 191, 36, 0.08);
            border: 1px solid rgba(251, 191, 36, 0.1);
        }

        /* Sub-section Card Style */
        .sub-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(254, 252, 232, 0.2) 25%, rgba(240, 249, 255, 0.2) 75%, rgba(255, 255, 255, 0.95) 100%);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(251, 191, 36, 0.1);
            transition: all 0.3s ease;
        }

        .sub-card:hover {
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.08);
        }

        /* Header Title Gradient */
        .header-title {
            background: linear-gradient(135deg, #1e293b 0%, #475569 50%, #0369a1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Form Input Styling */
        .form-input {
            transition: all 0.3s ease;
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid #e2e8f0;
            color: #334155;
        }

        .form-input:focus {
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.3);
            background: #fff;
        }

        /* Readonly Input Styling */
        .form-input-readonly {
            background: #f1f5f9;
            /* Slate-100 */
            cursor: not-allowed;
            color: #64748b;
            /* Slate-500 */
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }

        /* Preformatted Code Blocks */
        pre {
            background-color: #f7f9fb;
            border: 1px solid #e2e8f0;
            color: #334155;
            border-radius: 0.5rem;
            padding: 0.75rem;
            overflow-x: auto;
            font-size: 0.875rem;
        }

        /* Button Styling - Primary (Run Test) */
        .btn-primary {
            background: linear-gradient(45deg, #0ea5e9 0%, #1e40af 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #38bdf8 0%, #1e3a8a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(14, 165, 233, 0.4);
        }

        /* Button Styling - Secondary (Preview, Save, Cancel) */
        .btn-secondary {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(254, 252, 232, 0.8) 100%);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(251, 191, 36, 0.2);
            color: #475569;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(251, 191, 36, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 1);
            color: #1e293b;
            box-shadow: 0 4px 8px rgba(251, 191, 36, 0.2);
            transform: translateY(-1px);
        }

        /* Message Boxes - Theme Compliant */
        .message-success {
            background: linear-gradient(90deg, #dcfce7 0%, #f0fff4 100%);
            color: #166534;
            border: 1px solid #34d399;
        }

        .message-error {
            background: linear-gradient(90deg, #fef2f2 0%, #fff7f7 100%);
            color: #991b1b;
            border: 1px solid #f87171;
        }

        .message-info {
            background: linear-gradient(90deg, #eff6ff 0%, #f7fbff 100%);
            color: #1e40af;
            border: 1px solid #60a5fa;
        }

        .hidden-group {
            display: none;
        }

        /* Dark Mode Styles */
        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #0f172a 0%, #1e1b4b 25%, #164e63 50%, #134e4a 75%, #365314 100%);
            --card-bg: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 27, 75, 0.3) 25%, rgba(22, 78, 99, 0.3) 75%, rgba(15, 23, 42, 0.9) 100%);
            --sub-card-bg: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 27, 75, 0.2) 25%, rgba(22, 78, 99, 0.2) 75%, rgba(15, 23, 42, 0.95) 100%);
            --input-bg: rgba(30, 41, 59, 0.85);
            --input-placeholder: #64748b;
            --search-focus-border: #f59e0b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: rgba(251, 191, 36, 0.2);
            --table-bg: rgba(15, 23, 42, 0.8);
            --table-header-bg: rgba(30, 41, 59, 0.9);
            --table-text-primary: #f1f5f9;
            --table-text-secondary: #94a3b8;
            --table-border: rgba(51, 65, 85, 0.5);
            --table-hover-bg: rgba(51, 65, 85, 0.3);
        }

        [data-theme="dark"] body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        [data-theme="dark"] .main-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        [data-theme="dark"] .sub-card {
            background: var(--sub-card-bg);
            border: 1px solid var(--border-color);
        }

        [data-theme="dark"] .form-input {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] .form-input:focus {
            border-color: var(--search-focus-border);
            background: rgba(30, 41, 59, 1);
        }

        [data-theme="dark"] .form-input::placeholder {
            color: var(--input-placeholder);
        }

        [data-theme="dark"] .form-input-readonly {
            background: rgba(30, 41, 59, 0.5);
            color: var(--text-secondary);
        }

        [data-theme="dark"] pre {
            background-color: var(--table-header-bg);
            border: 1px solid var(--table-border);
            color: var(--table-text-primary);
        }

        [data-theme="dark"] .header-title {
            color: var(--text-primary);
        }

        [data-theme="dark"] .text-slate-700 {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .text-slate-800 {
            color: var(--text-primary);
        }

        [data-theme="dark"] .text-slate-600 {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .text-blue-600 {
            color: #60a5fa;
        }

        [data-theme="dark"] .hover\:text-amber-500:hover {
            color: #fbbf24;
        }

        [data-theme="dark"] .message-success {
            background: linear-gradient(90deg, rgba(6, 78, 59, 0.3), rgba(4, 120, 87, 0.3));
            color: #6ee7b7;
            border: 1px solid rgba(6, 95, 70, 0.5);
        }

        [data-theme="dark"] .message-error {
            background: linear-gradient(90deg, rgba(127, 29, 29, 0.3), rgba(153, 27, 27, 0.3));
            color: #fca5a5;
            border: 1px solid rgba(153, 27, 27, 0.5);
        }

        [data-theme="dark"] .message-info {
            background: linear-gradient(90deg, rgba(30, 58, 138, 0.3), rgba(37, 99, 235, 0.3));
            color: #93c5fd;
            border: 1px solid rgba(37, 99, 235, 0.5);
        }

        /* Dark Mode Toggle Button */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .dark-mode-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .dark-mode-toggle i {
            font-size: 1.2rem;
            color: #fbbf24;
            transition: transform 0.3s ease;
        }

        .dark-mode-toggle:hover i {
            transform: rotate(180deg);
        }

        [data-theme="dark"] .dark-mode-toggle {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
    </style>
</head>

<body class="p-6">
    <div class="dark-mode-toggle" onclick="toggleDarkMode()">
        <i class="fas fa-moon"></i>
    </div>
    <div class="max-w-8xl mx-auto main-card p-8">
        <div class="flex items-center justify-center mb-6">
            <i
                class="fas fa-feather-alt text-3xl bg-gradient-to-r from-amber-500 to-blue-500 bg-clip-text text-transparent mr-3"></i>
            <h1 class="text-3xl font-bold header-title text-center">Define Data Availability Test</h1>
        </div>

        <p class="mb-6">
            <a href="{% url 'project_details' project_id %}"
                class="text-blue-600 hover:text-amber-500 transition-colors font-medium flex items-center"
                aria-label="Back to Project">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Project
            </a>
        </p>

        {% if messages %}
        <ul class="mb-6">
            {% for message in messages %}
            <li>
                <div class="p-4 mb-3 rounded-xl text-sm font-medium
					{% if 'success' in message.tags %}
					message-success
					{% elif 'error' in message.tags %}
					message-error
					{% else %}
					message-info
					{% endif %}">
                    <div class="flex items-center">
                        {% if 'success' in message.tags %}
                        <i class="fas fa-check-circle mr-2"></i>
                        {% elif 'error' in message.tags %}
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        {% else %}
                        <i class="fas fa-info-circle mr-2"></i>
                        {% endif %}
                        {{ message }}
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% endif %}

        {% if validation_errors %}
        <div class="message-error px-4 py-3 rounded-xl relative mb-6" role="alert">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle mr-3 text-xl"></i>
                <strong class="font-bold">Validation Error!</strong>
            </div>
            <span class="block ml-7">Please correct the following issues:</span>
            <ul class="list-disc list-inside ml-7 text-sm mt-1">
                {% for error in validation_errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <form id="availabilityForm" action="{% url 'handle_test_execution_or_save' %}" method="POST" novalidate>
            {% csrf_token %}
            <input type="hidden" name="project_id" value="{{ project_id }}" />
            <input type="hidden" name="test_case_id"
                value="{% if test_case and test_case.test_case_id %}{{ test_case.test_case_id }}{% elif test_case_id %}{{ test_case_id }}{% else %}{% endif %}" />
            <input type="hidden" name="test_type" value="Availability Test" />

            <div class="sub-card p-6 mb-8">
                <h2 class="text-xl font-semibold text-slate-700 mb-4 border-b border-gray-100 pb-2">Test Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="test_name" class="block text-sm font-medium text-slate-700 mb-1">Test Name:</label>
                        <input type="text" id="test_name" name="test_name" required
                            class="form-input mt-1 block w-full px-3 py-2 sm:text-sm"
                            value="{{ test_case.test_name|default:'' }}" />
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-slate-700 mb-1">Category:</label>
                        <select id="category" name="category"
                            class="form-input mt-1 block w-full px-3 py-2 sm:text-sm">
                            <option value="">Select Category</option>
                            <option value="POWER BI" {% if request.POST.category == 'POWER BI' %}selected{% elif test_case and test_case.category == 'POWER BI' %}selected{% endif %}>POWER BI</option>
                            <option value="SQL" {% if request.POST.category == 'SQL' %}selected{% elif test_case and test_case.category == 'SQL' %}selected{% endif %}>SQL</option>
                            <option value="SAP" {% if request.POST.category == 'SAP' %}selected{% elif test_case and test_case.category == 'SAP' %}selected{% endif %}>SAP</option>
                            <option value="TBH" {% if request.POST.category == 'TBH' %}selected{% elif test_case and test_case.category == 'TBH' %}selected{% endif %}>TBH</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="sub-card p-6">
                    <h2 class="text-xl font-semibold text-slate-700 mb-4 border-b border-amber-100 pb-2">
                        <i class="fas fa-cloud-download-alt text-amber-500 mr-2"></i>Source Data
                    </h2>
                    <div class="space-y-5">
                        <div>
                            <label for="source_connection_source"
                                class="block text-sm font-medium text-slate-700 mb-1">Connection Source:</label>
                            <select id="source_connection_source" name="source_connection_source" required
                                class="form-input mt-1 block w-full px-3 py-2 sm:text-sm">
                                {% for conn_name in available_connection_sources %}
                                    <option value="{{ conn_name }}" {% if test_case.source_connection_source == conn_name %}selected{% endif %}>{{ conn_name }}</option>

                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="source_table" class="block text-sm font-medium text-slate-700 mb-1">Table
                                Name:</label>
                            <input id="source_table" name="source_table" required
                                class="form-input mt-1 block w-full px-3 py-2 sm:text-sm"
                                value="{{ test_case.source_table|default:'' }}" />
                        </div>
                        <div>
                            <label for="source_date_column"
                                class="block text-sm font-medium text-slate-700 mb-1">Primary Date
                                Column:</label>
                            <input id="source_date_column" name="source_date_column" required
                                class="form-input mt-1 block w-full px-3 py-2 sm:text-sm"
                                value="{{ test_case.source_date_column|default:'' }}" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Aggregation Type:</label>
                            <input type="text" value="COUNT" readonly
                                class="form-input-readonly mt-1 block w-full px-3 py-2 sm:text-sm" />
                            <input type="hidden" name="source_aggregation_type" value="COUNT" />
                        </div>
                        <div>
                            <label for="source_aggregation_column"
                                class="block text-sm font-medium text-slate-700 mb-1">Aggregation Column:</label>
                            <input id="source_aggregation_column" name="source_aggregation_column" required
                                class="form-input mt-1 block w-full px-3 py-2 sm:text-sm"
                                placeholder="e.g., ID, PRIMARY_KEY"
                                value="{% if request.POST.source_aggregation_column %}{{ request.POST.source_aggregation_column }}{% elif test_case and test_case.source_agg_column %}{{ test_case.source_agg_column }}{% elif test_case and test_case.source_aggregation_column %}{{ test_case.source_aggregation_column }}{% else %}{% endif %}" />
                        </div>
                        <div>
                            <label for="source_additional_filters"
                                class="block text-sm font-medium text-slate-700 mb-1">Additional Filters (SQL WHERE
                                clause snippet - optional):</label>
                            <textarea id="source_additional_filters" name="source_additional_filters"
                                class="form-input mt-1 block w-full px-3 py-2 sm:text-sm resize-none"
                                rows="3">{{ test_case.source_additional_filters|default:'' }}</textarea>
                        </div>

                        <div id="source_powerbi_fields" style="display:none;"
                            class="space-y-4 pt-4 border-t border-gray-100">
                            <div>
                                <label for="source_workspace_id"
                                    class="block text-sm font-medium text-slate-700 mb-1">Power BI Workspace ID:</label>
                                <input type="text" id="source_workspace_id" name="source_workspace_id"
                                    class="form-input mt-1 block w-full px-3 py-2 sm:text-sm"
                                    value="{% if request.POST.source_workspace_id %}{{ request.POST.source_workspace_id }}{% elif test_case and test_case.source_workspace_id %}{{ test_case.source_workspace_id }}{% endif %}">
                            </div>
                            <div>
                                <label for="source_dataset_id"
                                    class="block text-sm font-medium text-slate-700 mb-1">Power BI Dataset ID:</label>
                                <input type="text" id="source_dataset_id" name="source_dataset_id"
                                    class="form-input mt-1 block w-full px-3 py-2 sm:text-sm"
                                    value="{% if request.POST.source_dataset_id %}{{ request.POST.source_dataset_id }}{% elif test_case and test_case.source_dataset_id %}{{ test_case.source_dataset_id }}{% endif %}">
                            </div>
                            <div>
                                <label for="source_dax_query"
                                    class="block text-sm font-medium text-slate-700 mb-1">Custom DAX Query
                                    (Optional):</label>
                                <textarea id="source_dax_query" name="source_dax_query" rows="5"
                                    class="form-input mt-1 block w-full px-3 py-2 sm:text-sm resize-none">{% if request.POST.source_dax_query %}{{ request.POST.source_dax_query }}{% elif test_case and test_case.source_dax_query %}{{ test_case.source_dax_query }}{% endif %}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sub-card p-6">
                    <h2 class="text-xl font-semibold text-slate-700 mb-4 border-b border-blue-100 pb-2">
                        <i class="fas fa-chart-line text-blue-500 mr-2"></i>Destination Data
                    </h2>
                    <div class="space-y-5">
                        <div>
                            <label for="destination_connection_source"
                                class="block text-sm font-medium text-slate-700 mb-1">Connection Source:</label>
                            <select id="destination_connection_source" name="destination_connection_source" required
                                class="form-input mt-1 block w-full px-3 py-2 sm:text-sm">
                                {% for conn_name in available_connection_sources %}
                                    <option value="{{ conn_name }}" {% if test_case.destination_connection_source == conn_name %} selected{% endif %}>{{ conn_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="destination_table" class="block text-sm font-medium text-slate-700 mb-1">Table
                                Name:</label>
                            <input id="destination_table" name="destination_table" required
                                class="form-input mt-1 block w-full px-3 py-2 sm:text-sm"
                                value="{{ test_case.destination_table|default:'' }}" />
                        </div>
                        <div>
                            <label for="destination_date_column"
                                class="block text-sm font-medium text-slate-700 mb-1">Primary
                                Date Column:</label>
                            <input id="destination_date_column" name="destination_date_column" required
                                class="form-input mt-1 block w-full px-3 py-2 sm:text-sm"
                                value="{{ test_case.destination_date_column|default:'' }}" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Aggregation Type:</label>
                            <input type="text" value="COUNT" readonly
                                class="form-input-readonly mt-1 block w-full px-3 py-2 sm:text-sm" />
                            <input type="hidden" name="destination_aggregation_type" value="COUNT" />
                        </div>
                        <div>
                            <label for="destination_aggregation_column"
                                class="block text-sm font-medium text-slate-700 mb-1">Aggregation Column:</label>
                            <input id="destination_aggregation_column" name="destination_aggregation_column" required
                                class="form-input mt-1 block w-full px-3 py-2 sm:text-sm"
                                placeholder="e.g., ID, PRIMARY_KEY"
                                value="{% if request.POST.destination_aggregation_column %}{{ request.POST.destination_aggregation_column }}{% elif test_case and test_case.destination_agg_column %}{{ test_case.destination_agg_column }}{% elif test_case and test_case.destination_aggregation_column %}{{ test_case.destination_aggregation_column }}{% else %}{% endif %}" />
                        </div>
                        <div>
                            <label for="destination_additional_filters"
                                class="block text-sm font-medium text-slate-700 mb-1">Additional Filters (SQL WHERE
                                clause snippet - optional):</label>
                            <textarea id="destination_additional_filters" name="destination_additional_filters"
                                class="form-input mt-1 block w-full px-3 py-2 sm:text-sm resize-none"
                                rows="3">{{ test_case.destination_additional_filters|default:'' }}</textarea>
                        </div>

                        <div id="destination_powerbi_fields" style="display:none;"
                            class="space-y-4 pt-4 border-t border-gray-100">
                            <div>
                                <label for="destination_workspace_id"
                                    class="block text-sm font-medium text-slate-700 mb-1">Power BI Workspace ID:</label>
                                <input type="text" id="destination_workspace_id" name="destination_workspace_id"
                                    class="form-input mt-1 block w-full px-3 py-2 sm:text-sm"
                                    value="{% if request.POST.destination_workspace_id %}{{ request.POST.destination_workspace_id }}{% elif test_case and test_case.destination_workspace_id %}{{ test_case.destination_workspace_id }}{% endif %}">
                            </div>
                            <div>
                                <label for="destination_dataset_id"
                                    class="block text-sm font-medium text-slate-700 mb-1">Power BI Dataset ID:</label>
                                <input type="text" id="destination_dataset_id" name="destination_dataset_id"
                                    class="form-input mt-1 block w-full px-3 py-2 sm:text-sm"
                                    value="{% if request.POST.destination_dataset_id %}{{ request.POST.destination_dataset_id }}{% elif test_case and test_case.destination_dataset_id %}{{ test_case.destination_dataset_id }}{% endif %}">
                            </div>
                            <div>
                                <label for="destination_dax_query"
                                    class="block text-sm font-medium text-slate-700 mb-1">Custom DAX Query
                                    (Optional):</label>
                                <textarea id="destination_dax_query" name="destination_dax_query" rows="5"
                                    class="form-input mt-1 block w-full px-3 py-2 sm:text-sm resize-none">{% if request.POST.destination_dax_query %}{{ request.POST.destination_dax_query }}{% elif test_case and test_case.destination_dax_query %}{{ test_case.destination_dax_query }}{% endif %}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sub-card p-6 mt-8">
                <h2 class="text-xl font-semibold text-slate-700 mb-4 border-b border-gray-100 pb-2">Comparison Logic</h2>
                <div class="mt-4">
                    <label for="possible_resolution" class="block text-sm font-medium text-slate-700 mb-1">Possible Resolution (Optional):</label>
                    <textarea id="possible_resolution" name="possible_resolution" rows="3"
                        class="form-input mt-1 block w-full px-3 py-2 sm:text-sm resize-none"
                        placeholder="Describe possible steps to resolve issues if the test fails">{% if request.POST.possible_resolution %}{{ request.POST.possible_resolution }}{% elif test_case and test_case.possible_resolution %}{{ test_case.possible_resolution }}{% endif %}</textarea>
                </div>
            </div>

            <input type="hidden" name="threshold" value="0">
            <input type="hidden" name="threshold_type" value="ABSOLUTE">
            <div class="text-center mt-10 space-x-6">
                <button type="submit" name="action" value="preview"
                    class="btn-secondary inline-flex justify-center py-2.5 px-6 text-sm font-semibold rounded-lg">
                    <i class="fas fa-eye mr-2"></i>Preview Data
                </button>
                <button type="submit" name="action" value="run"
                    class="btn-primary inline-flex justify-center py-2.5 px-6 text-sm font-semibold rounded-lg">
                    <i class="fas fa-rocket mr-2"></i>Run Availability Test
                </button>
                <button type="submit" name="action" value="save"
                    class="btn-secondary inline-flex justify-center py-2.5 px-6 text-sm font-semibold rounded-lg">
                    <i class="fas fa-save mr-2"></i>Save Test Definition
                </button>
                <a href="{% url 'project_details' project_id %}"
                    class="btn-secondary inline-flex justify-center py-2.5 px-6 text-sm font-semibold rounded-lg">
                    <i class="fas fa-times-circle mr-2"></i>Cancel
                </a>
            </div>
        </form>

        {% if preview_results %}
        <div class="sub-card p-6 mt-10">
            <h2 class="text-xl font-semibold text-slate-700 mb-4 border-b border-gray-100 pb-2">
                <i class="fas fa-chart-bar text-green-500 mr-2"></i>Preview Results
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-lg font-semibold text-slate-800 mb-2">Source Count (Today):</p>
                    <pre>{{ preview_results.source_value }}</pre>
                    <p class="text-slate-700 font-medium mt-4">Source Query:</p>
                    <pre>{{ preview_results.source_query }}</pre>
                    <p class="text-slate-700 font-medium mt-2 text-sm">Connection: <span
                            class="font-normal text-slate-600">{{ preview_results.source_connection_used }}</span></p>
                </div>
                <div>
                    <p class="text-lg font-semibold text-slate-800 mb-2">Destination Count (Today):</p>
                    <pre>{{ preview_results.destination_value }}</pre>
                    <p class="text-slate-700 font-medium mt-4">Destination Query:</p>
                    <pre>{{ preview_results.destination_query }}</pre>
                    <p class="text-slate-700 font-medium mt-2 text-sm">Connection: <span
                            class="font-normal text-slate-600">{{ preview_results.destination_connection_used }}</span>
                    </p>
                </div>
            </div>
            {% if preview_results.message %}
            <p class="message-error p-3 rounded-md mt-4">{{ preview_results.message }}</p>
            {% endif %}
        </div>
        {% endif %}

        {% if test_results %}
        <div class="sub-card p-6 mt-10">
            <h2 class="text-xl font-semibold text-slate-700 mb-4 border-b border-gray-100 pb-2">
                <i class="fas fa-clipboard-check text-indigo-500 mr-2"></i>Full Test Results
            </h2>
            <div class="p-4 rounded-xl mb-4 
				{% if test_results.status == 'PASS' %}message-success
				{% elif test_results.status == 'ERROR' %}message-error
				{% else %}message-info{% endif %}">
                <p class="text-lg font-semibold flex items-center">
                    <span class="mr-3">Overall Status:</span>
                    <span class="px-4 py-1 rounded-full text-sm font-bold bg-white shadow-sm">
                        {{ test_results.status }}
                    </span>
                </p>
                <p class="text-sm mt-2 font-medium">{{ test_results.message }}</p>
            </div>
            <div class="border-t border-gray-200 pt-4 mt-4 grid grid-cols-2 gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-slate-700 mb-3">Comparison Details:</h3>
                    <p class="text-slate-800 text-sm"><strong>Source Count:</strong> <code
                            class="font-mono bg-gray-100 px-1 rounded">{{ test_results.source_value }}</code></p>
                    <p class="text-slate-800 text-sm"><strong>Destination Count:</strong> <code
                            class="font-mono bg-gray-100 px-1 rounded">{{ test_results.destination_value }}</code></p>
                    <p class="text-slate-800 text-sm"><strong>Difference:</strong> <code
                            class="font-mono bg-gray-100 px-1 rounded">{{ test_results.difference }}</code></p>
                    <p class="text-slate-800 text-sm"><strong>Threshold:</strong> {{ test_results.threshold }}
                        ({{ test_results.threshold_type }})</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-slate-700 mb-3">Connections Used:</h3>
                    <p class="text-slate-800 text-sm"><strong>Source:</strong> {{ test_results.source_connection_used }}
                    </p>
                    <p class="text-slate-800 text-sm"><strong>Destination:</strong> {{ test_results.destination_connection_used }}</p>
                </div>
            </div>
            <div class="border-t border-gray-200 pt-4 mt-4">
                <h3 class="text-lg font-semibold text-slate-700 mb-3">Generated/Custom Queries:</h3>
                <p class="text-slate-700 font-medium mt-2">Source Query:</p>
                <pre>{{ test_results.source_query }}</pre>
                <p class="text-slate-700 font-medium mt-2">Destination Query:</p>
                <pre>{{ test_results.destination_query }}</pre>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('eagle-dq-theme', newTheme);

            // Update icon
            const icon = document.querySelector('.dark-mode-toggle i');
            if (newTheme === 'dark') {
                icon.className = 'fas fa-sun';
            } else {
                icon.className = 'fas fa-moon';
            }

            // Dispatch custom event for consistency
            window.dispatchEvent(new CustomEvent('themeChange', { detail: { theme: newTheme } }));
        }

        function showHidePowerBIFields(prefix) {
            const connSelect = document.getElementById(prefix + '_connection_source');
            const powerbiFields = document.getElementById(prefix + '_powerbi_fields');

            // Find all required SQL fields (table, date_column, agg_column)
            const requiredSqlFields = [
                document.getElementById(prefix + '_table'),
                document.getElementById(prefix + '_date_column'),
                document.getElementById(prefix + '_aggregation_column')
            ].filter(el => el);

            if (!connSelect || !powerbiFields) return;

            if (connSelect.value === 'Power BI') {
                powerbiFields.style.display = 'block';
                // Remove required attribute from SQL fields when Power BI is selected
                requiredSqlFields.forEach(el => el.removeAttribute('required'));
            } else {
                powerbiFields.style.display = 'none';
                // Add required attribute back to SQL fields when SQL source is selected
                requiredSqlFields.forEach(el => el.setAttribute('required', 'required'));
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Load saved theme
            const savedTheme = localStorage.getItem('eagle-dq-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);

            // Update icon based on saved theme
            const icon = document.querySelector('.dark-mode-toggle i');
            if (savedTheme === 'dark') {
                icon.className = 'fas fa-sun';
            } else {
                icon.className = 'fas fa-moon';
            }

            // Apply form-input styling to all relevant elements on load
            document.querySelectorAll('input:not([type="hidden"]):not([readonly]), select, textarea').forEach(el => {
                el.classList.add('form-input');
                // Remove conflicting default Tailwind classes
                el.classList.remove('border-gray-300', 'shadow-sm', 'focus:outline-none', 'focus:ring', 'focus:ring-indigo-500', 'bg-white');
                el.classList.add('bg-white');
            });

            // Apply specific readonly style
            document.querySelectorAll('input[readonly]').forEach(el => {
                el.classList.remove('form-input', 'bg-gray-100', 'cursor-not-allowed');
                el.classList.add('form-input-readonly');
            });

            // Initialize Power BI toggling
            ['source', 'destination'].forEach(prefix => {
                const connSelect = document.getElementById(prefix + '_connection_source');
                if (connSelect) {
                    showHidePowerBIFields(prefix);
                    connSelect.addEventListener('change', () => showHidePowerBIFields(prefix));
                }
            });
        });
    </script>
</body>

</html>